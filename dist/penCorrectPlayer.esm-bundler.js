import{__extends as e,__assign as t,__spreadArray as n}from"tslib";import i from"mitt";var r={TIME_UPDATE:"time_update",TIME_ENDED:"time_ended",DRAWING:"drawing",PAGE_DRAWING:"page_drawing"},a=function(){Object.assign(this,i())},o=function(t){function n(e,n,i,r,a){var o=t.call(this)||this;return Object.defineProperty(o,"_pageId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(o,"_canvas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(o,"_penDatas",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(o,"_leftPenDatas",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(o,"_prevDrawPoint",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(o,"_strokeWidth",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(o,"_ctx",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),o._pageId=e,o._canvas=n,o._penDatas=r||[],o._leftPenDatas=a||[],o._strokeWidth=i||1,o._ctx=n.getContext("2d"),o}return e(n,t),Object.defineProperty(n.prototype,"showToCanvas",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e=this,t=this._parseToLines(this._penDatas);0!==t.length&&(this._ctx.beginPath(),this._setLineConfigBeforePath(this._ctx),t.forEach((function(t){var n=t.points,i=n[0],r=n.slice(1);e._ctx.moveTo(i.x,i.y),null==r||r.forEach((function(t){e._ctx.lineTo(t.x,t.y)}))})),this._ctx.stroke())}}),Object.defineProperty(n.prototype,"_parseToLines",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t,n=[];return e.forEach((function(e){var i={x:e.x,y:e.y};"PEN_DOWN"===e.type?n.push(t={points:[i]}):"PEN_MOVE"!==e.type&&"PEN_UP"!==e.type||(t||n.push(t={points:[i]}),t.points.push(i))})),n}}),Object.defineProperty(n.prototype,"findPointsAndDraw",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){var n=this,i=this._leftPenDatas.findIndex((function(n,i){return n.ts-e>t})),r=this._leftPenDatas.splice(0,-1===i?this._leftPenDatas.length:i);r.length>0&&this._splitPointsByColor(r).forEach((function(e,t){n._drawPointsToCanvas(e)}));return r}}),Object.defineProperty(n.prototype,"_splitPointsByColor",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t=[],n=[];return e.forEach((function(i,r){0===r||i.strokeStyle===e[r-1].strokeStyle?n.push(i):(t.push(n),n=[i])})),t.push(n),t}}),Object.defineProperty(n.prototype,"_drawPointsToCanvas",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t,n=this;this._ctx.strokeStyle=e[0].strokeStyle,this._ctx.beginPath(),this._setLineConfigBeforePath(this._ctx),["PEN_DOWN","PEN_MOVE"].includes(null===(t=this._prevDrawPoint)||void 0===t?void 0:t.type)&&this._ctx.moveTo(this._prevDrawPoint.x,this._prevDrawPoint.y),e.forEach((function(t,i){"PEN_DOWN"===t.type?n._ctx.moveTo(t.x,t.y):n._ctx.lineTo(t.x,t.y),i===e.length-1&&(n._prevDrawPoint=t)})),this._ctx.stroke()}}),Object.defineProperty(n.prototype,"_setLineConfigBeforePath",{enumerable:!1,configurable:!0,writable:!0,value:function(e){e.imageSmoothingEnabled=!0,e.lineJoin="round",e.lineCap="round",e.lineWidth=this._strokeWidth}}),Object.defineProperty(n.prototype,"leftPenDatas",{get:function(){return this._leftPenDatas},set:function(e){this._leftPenDatas=e},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"penDatas",{get:function(){return this._penDatas},set:function(e){this._penDatas=e},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"canvas",{get:function(){return this._canvas},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"destroy",{enumerable:!1,configurable:!0,writable:!0,value:function(){this._canvas=null,this._ctx=null,this._penDatas=[],this._leftPenDatas=[],this._prevDrawPoint=null}}),Object.defineProperty(n.prototype,"clear",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e,t,n;null===(e=this._ctx)||void 0===e||e.clearRect(0,0,null===(t=this._canvas)||void 0===t?void 0:t.width,null===(n=this._canvas)||void 0===n?void 0:n.height)}}),n}(a),s={strokeWidth:1,realPageWidth:210,realPageHeight:297},l=function(i){function a(e,t){var n=i.call(this,e,t)||this;return Object.defineProperty(n,"_curTime",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(n,"_rate",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(n,"_isplaying",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(n,"_myRequestAnimationFrame",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(n,"_currentDrawingInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(n,"_prevAnimationTimestamp",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(n,"_currentAnimationTimestamp",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),n}return e(a,i),Object.defineProperty(a.prototype,"show",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e=this;Object.keys(this._pagesInfo).forEach((function(t){e._pagesInfo[t].showToCanvas()}))}}),Object.defineProperty(a.prototype,"play",{enumerable:!1,configurable:!0,writable:!0,value:function(){this._isplaying||(this._isplaying=!0,this._myRequestAnimationFrame=window.requestAnimationFrame(this._doAnimationStep.bind(this)))}}),Object.defineProperty(a.prototype,"_doAnimationStep",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t=this;this._prevAnimationTimestamp||(this._prevAnimationTimestamp=e),this._currentAnimationTimestamp=e;var n=this._curTime+this._rate*(this._currentAnimationTimestamp-this._prevAnimationTimestamp);n>0&&this._findPointsAndDraw(n),Object.keys(this._pagesInfo).find((function(e){return t._pagesInfo[e].leftPenDatas.length>0}))||n<this.totalTime?this._myRequestAnimationFrame=window.requestAnimationFrame(this._doAnimationStep.bind(this)):(this.emit(r.TIME_ENDED),this._prevAnimationTimestamp=null,this._currentAnimationTimestamp=null,this._isplaying=!1),this.currentTime=n,this._prevAnimationTimestamp=this._currentAnimationTimestamp}}),Object.defineProperty(a.prototype,"_findPointsAndDraw",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t,n=this,i=[];Object.keys(this._pagesInfo).forEach((function(r){var a=n._pagesInfo[r].findPointsAndDraw(n._firstPointTimestamp,e);a.length>0&&(0===i.length||i[i.length-1].ts<a[a.length-1].ts)&&(i=a,t=r)})),i.length>0&&this.emit(r.DRAWING,{pageId:t,drawingPoints:i})}}),Object.defineProperty(a.prototype,"_resetLeftPenDatas",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e=this;Object.keys(this._pagesInfo).forEach((function(t){var n=e._pagesInfo[t];n.leftPenDatas=Array.from(n.penDatas)}))}}),Object.defineProperty(a.prototype,"replay",{enumerable:!1,configurable:!0,writable:!0,value:function(){this.currentTime=0,this._clearCanvas(),this._resetLeftPenDatas(),this.play()}}),Object.defineProperty(a.prototype,"seek",{enumerable:!1,configurable:!0,writable:!0,value:function(e){this._clearCanvas(),this._resetLeftPenDatas(),this._findPointsAndDraw(e),this.currentTime=e}}),Object.defineProperty(a.prototype,"update",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e=this;Object.keys(this._pagesInfo).forEach((function(i){var r=e._pagesInfo[i],a=r.penDatas.map((function(n){return t(t({},n),e._transformPagePointToCanvasPoint(r.canvas.width,r.canvas.height,n.originalPoint))}));r.penDatas=a,r.leftPenDatas=n([],a,!0)})),this._findPointsAndDraw(this.currentTime)}}),Object.defineProperty(a.prototype,"totalTime",{get:function(){return this.lastPointTimestamp-this._firstPointTimestamp},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"currentTime",{get:function(){return this._curTime},set:function(e){this._curTime!==e&&(this.emit(r.TIME_UPDATE,e),this._curTime=e)},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"rate",{get:function(){return this._rate},set:function(e){this._rate=e},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"pause",{enumerable:!1,configurable:!0,writable:!0,value:function(){this._myRequestAnimationFrame&&window.cancelAnimationFrame(this._myRequestAnimationFrame),this._prevAnimationTimestamp=null,this._isplaying=!1}}),Object.defineProperty(a.prototype,"_clearCanvas",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e=this;Object.keys(this._pagesInfo).forEach((function(t){e._pagesInfo[t].clear()}))}}),Object.defineProperty(a.prototype,"destroy",{enumerable:!1,configurable:!0,writable:!0,value:function(){this._myRequestAnimationFrame&&window.cancelAnimationFrame(this._myRequestAnimationFrame),this._currentDrawingInfo=null,this._clearCanvas(),i.prototype.destroy.call(this)}}),a}(function(n){function i(e,i){var r=n.call(this)||this;return Object.defineProperty(r,"_pagesInfo",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(r,"_config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(r,"_firstPointTimestamp",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),r._config=t(t({},s),i),Object.keys(e).forEach((function(t){r._pagesInfo[t]=r._createPage(String(t),e[t])})),r}return e(i,n),Object.defineProperty(i.prototype,"_transformPagePointToCanvasPoint",{enumerable:!1,configurable:!0,writable:!0,value:function(e,n,i){var r=i.x?this._roundNumber(e*i.x/(this._config.realPageWidth/1.524)):i.xP*e,a=i.y?this._roundNumber(n*i.y/(this._config.realPageHeight/1.524)):i.yP*n;return t(t({},i),{x:r,y:a,originalPoint:i})}}),Object.defineProperty(i.prototype,"_roundNumber",{enumerable:!1,configurable:!0,writable:!0,value:function(e){return Math.round(e*Math.pow(10,15))/Math.pow(10,15)}}),Object.defineProperty(i.prototype,"appendPagePenData",{enumerable:!1,configurable:!0,writable:!0,value:function(e,n,i,r){var a,o,s=this;if(void 0===r&&(r="black"),!((null==n?void 0:n.length)<=0)){var l=this._pagesInfo[e];if(!l){if(!i)throw new Error("canvas参数为空");l=this._pagesInfo[e]=this._createPage(e,i)}var u=null!==(a=null==l?void 0:l.penDatas)&&void 0!==a?a:[],c=null!==(o=null==l?void 0:l.leftPenDatas)&&void 0!==o?o:[],f=u[u.length-1],p=n.map((function(e){return"PEN_MOVE"===e.type&&(f&&"PEN_UP"!==f.type||(e.type="PEN_DOWN")),f=e,t({strokeStyle:r},s._transformPagePointToCanvasPoint(i.width,i.height,e))}));u=u.concat(p),c=c.concat(p),l.penDatas=u,l.leftPenDatas=c,this._firstPointTimestamp?u[0].ts<this._firstPointTimestamp&&(this._firstPointTimestamp=u[0].ts):this._firstPointTimestamp=u[0].ts}}}),Object.defineProperty(i.prototype,"_createPage",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){return new o(e,t,this._config.strokeWidth)}}),Object.defineProperty(i.prototype,"destroy",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e=this;Object.keys(this._pagesInfo).forEach((function(t){e._pagesInfo[t].destroy()})),this._pagesInfo=null,this._config=null,this._firstPointTimestamp=null}}),Object.defineProperty(i.prototype,"firstPointTimestramp",{get:function(){return this._firstPointTimestamp},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"lastPointTimestamp",{get:function(){var e,t=this;return this._pagesInfo?(Object.keys(this._pagesInfo).forEach((function(n){var i=t._pagesInfo[n].penDatas;if(0!==i.length){var r=i[i.length-1];e?r.ts>e&&(e=r.ts):e=r.ts}})),e):0},enumerable:!1,configurable:!0}),i}(a));export{r as Events,l as PenCorrectPlayer};
