var PenPlayer=function(e){"use strict";var t={TIME_UPDATE:"time_update",TIME_ENDED:"time_ended",DRAWING:"drawing",PAGE_DRAWING:"page_drawing"},n=function(e,t){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},n(e,t)};function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function i(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}var r=function(){return r=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},r.apply(this,arguments)};var a=function(){var e;Object.assign(this,{all:e=e||new Map,on:function(t,n){var i=e.get(t);i?i.push(n):e.set(t,[n])},off:function(t,n){var i=e.get(t);i&&(n?i.splice(i.indexOf(n)>>>0,1):e.set(t,[]))},emit:function(t,n){var i=e.get(t);i&&i.slice().map((function(e){e(n)})),(i=e.get("*"))&&i.slice().map((function(e){e(t,n)}))}})},o=function(e){function t(t,n,i,r,a){var o=e.call(this)||this;return Object.defineProperty(o,"_pageId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(o,"_canvas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(o,"_penDatas",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(o,"_leftPenDatas",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(o,"_prevDrawPoint",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(o,"_strokeWidth",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(o,"_ctx",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),o._pageId=t,o._canvas=n,o._penDatas=r||[],o._leftPenDatas=a||[],o._strokeWidth=i||1,o._ctx=n.getContext("2d"),o}return i(t,e),Object.defineProperty(t.prototype,"showToCanvas",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e=this,t=this._parseToLines(this._penDatas);0!==t.length&&(this._ctx.beginPath(),this._setLineConfigBeforePath(this._ctx),t.forEach((function(t){var n=t.points,i=n[0],r=n.slice(1);e._ctx.moveTo(i.x,i.y),null==r||r.forEach((function(t){e._ctx.lineTo(t.x,t.y)}))})),this._ctx.stroke())}}),Object.defineProperty(t.prototype,"_parseToLines",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t,n=[];return e.forEach((function(e){var i={x:e.x,y:e.y};"PEN_DOWN"===e.type?n.push(t={points:[i]}):"PEN_MOVE"!==e.type&&"PEN_UP"!==e.type||(t||n.push(t={points:[i]}),t.points.push(i))})),n}}),Object.defineProperty(t.prototype,"findPointsAndDraw",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){var n=this,i=this._leftPenDatas.findIndex((function(n,i){return n.ts-e>t})),r=this._leftPenDatas.splice(0,-1===i?this._leftPenDatas.length:i);r.length>0&&this._splitPointsByColor(r).forEach((function(e,t){n._drawPointsToCanvas(e)}));return r}}),Object.defineProperty(t.prototype,"_splitPointsByColor",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t=[],n=[];return e.forEach((function(i,r){0===r||i.strokeStyle===e[r-1].strokeStyle?n.push(i):(t.push(n),n=[i])})),t.push(n),t}}),Object.defineProperty(t.prototype,"_drawPointsToCanvas",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t,n=this;this._ctx.strokeStyle=e[0].strokeStyle,this._ctx.beginPath(),this._setLineConfigBeforePath(this._ctx),["PEN_DOWN","PEN_MOVE"].includes(null===(t=this._prevDrawPoint)||void 0===t?void 0:t.type)&&this._ctx.moveTo(this._prevDrawPoint.x,this._prevDrawPoint.y),e.forEach((function(t,i){"PEN_DOWN"===t.type?n._ctx.moveTo(t.x,t.y):n._ctx.lineTo(t.x,t.y),i===e.length-1&&(n._prevDrawPoint=t)})),this._ctx.stroke()}}),Object.defineProperty(t.prototype,"_setLineConfigBeforePath",{enumerable:!1,configurable:!0,writable:!0,value:function(e){e.imageSmoothingEnabled=!0,e.lineJoin="round",e.lineCap="round",e.lineWidth=this._strokeWidth}}),Object.defineProperty(t.prototype,"leftPenDatas",{get:function(){return this._leftPenDatas},set:function(e){this._leftPenDatas=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"penDatas",{get:function(){return this._penDatas},set:function(e){this._penDatas=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"canvas",{get:function(){return this._canvas},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"destroy",{enumerable:!1,configurable:!0,writable:!0,value:function(){this._canvas=null,this._ctx=null,this._penDatas=[],this._leftPenDatas=[],this._prevDrawPoint=null}}),Object.defineProperty(t.prototype,"clear",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e,t,n;null===(e=this._ctx)||void 0===e||e.clearRect(0,0,null===(t=this._canvas)||void 0===t?void 0:t.width,null===(n=this._canvas)||void 0===n?void 0:n.height)}}),t}(a),s={strokeWidth:1,realPageWidth:210,realPageHeight:297},l=function(e){function n(t,n){var i=e.call(this,t,n)||this;return Object.defineProperty(i,"_curTime",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(i,"_rate",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(i,"_isplaying",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(i,"_myRequestAnimationFrame",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(i,"_currentDrawingInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(i,"_prevAnimationTimestamp",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(i,"_currentAnimationTimestamp",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),i}return i(n,e),Object.defineProperty(n.prototype,"show",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e=this;Object.keys(this._pagesInfo).forEach((function(t){e._pagesInfo[t].showToCanvas()}))}}),Object.defineProperty(n.prototype,"play",{enumerable:!1,configurable:!0,writable:!0,value:function(){this._isplaying||(this._isplaying=!0,this._myRequestAnimationFrame=window.requestAnimationFrame(this._doAnimationStep.bind(this)))}}),Object.defineProperty(n.prototype,"_doAnimationStep",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var n=this;this._prevAnimationTimestamp||(this._prevAnimationTimestamp=e),this._currentAnimationTimestamp=e;var i=this._curTime+this._rate*(this._currentAnimationTimestamp-this._prevAnimationTimestamp);i>0&&this._findPointsAndDraw(i),Object.keys(this._pagesInfo).find((function(e){return n._pagesInfo[e].leftPenDatas.length>0}))||i<this.totalTime?this._myRequestAnimationFrame=window.requestAnimationFrame(this._doAnimationStep.bind(this)):(this.emit(t.TIME_ENDED),this._prevAnimationTimestamp=null,this._currentAnimationTimestamp=null,this._isplaying=!1),this.currentTime=i,this._prevAnimationTimestamp=this._currentAnimationTimestamp}}),Object.defineProperty(n.prototype,"_findPointsAndDraw",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var n,i=this,r=[];Object.keys(this._pagesInfo).forEach((function(t){var a=i._pagesInfo[t].findPointsAndDraw(i._firstPointTimestamp,e);a.length>0&&(0===r.length||r[r.length-1].ts<a[a.length-1].ts)&&(r=a,n=t)})),r.length>0&&this.emit(t.DRAWING,{pageId:n,drawingPoints:r})}}),Object.defineProperty(n.prototype,"_resetLeftPenDatas",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e=this;Object.keys(this._pagesInfo).forEach((function(t){var n=e._pagesInfo[t];n.leftPenDatas=Array.from(n.penDatas)}))}}),Object.defineProperty(n.prototype,"replay",{enumerable:!1,configurable:!0,writable:!0,value:function(){this.currentTime=0,this._clearCanvas(),this._resetLeftPenDatas(),this.play()}}),Object.defineProperty(n.prototype,"seek",{enumerable:!1,configurable:!0,writable:!0,value:function(e){this._clearCanvas(),this._resetLeftPenDatas(),this._findPointsAndDraw(e),this.currentTime=e}}),Object.defineProperty(n.prototype,"update",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e=this;Object.keys(this._pagesInfo).forEach((function(t){var n=e._pagesInfo[t],i=n.penDatas.map((function(t){return r(r({},t),e._transformPagePointToCanvasPoint(n.canvas.width,n.canvas.height,t.originalPoint))}));n.penDatas=i,n.leftPenDatas=function(e,t,n){if(n||2===arguments.length)for(var i,r=0,a=t.length;r<a;r++)!i&&r in t||(i||(i=Array.prototype.slice.call(t,0,r)),i[r]=t[r]);return e.concat(i||Array.prototype.slice.call(t))}([],i,!0)})),this._findPointsAndDraw(this.currentTime)}}),Object.defineProperty(n.prototype,"totalTime",{get:function(){return this.lastPointTimestamp-this._firstPointTimestamp},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"currentTime",{get:function(){return this._curTime},set:function(e){this._curTime!==e&&(this.emit(t.TIME_UPDATE,e),this._curTime=e)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"rate",{get:function(){return this._rate},set:function(e){this._rate=e},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"pause",{enumerable:!1,configurable:!0,writable:!0,value:function(){this._myRequestAnimationFrame&&window.cancelAnimationFrame(this._myRequestAnimationFrame),this._prevAnimationTimestamp=null,this._isplaying=!1}}),Object.defineProperty(n.prototype,"_clearCanvas",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e=this;Object.keys(this._pagesInfo).forEach((function(t){e._pagesInfo[t].clear()}))}}),Object.defineProperty(n.prototype,"destroy",{enumerable:!1,configurable:!0,writable:!0,value:function(){this._myRequestAnimationFrame&&window.cancelAnimationFrame(this._myRequestAnimationFrame),this._currentDrawingInfo=null,this._clearCanvas(),e.prototype.destroy.call(this)}}),n}(function(e){function t(t,n){var i=e.call(this)||this;return Object.defineProperty(i,"_pagesInfo",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(i,"_config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(i,"_firstPointTimestamp",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),i._config=r(r({},s),n),Object.keys(t).forEach((function(e){i._pagesInfo[e]=i._createPage(String(e),t[e])})),i}return i(t,e),Object.defineProperty(t.prototype,"_transformPagePointToCanvasPoint",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t,n){var i=n.x?this._roundNumber(e*n.x/(this._config.realPageWidth/1.524)):n.xP*e,a=n.y?this._roundNumber(t*n.y/(this._config.realPageHeight/1.524)):n.yP*t;return r(r({},n),{x:i,y:a,originalPoint:n})}}),Object.defineProperty(t.prototype,"_roundNumber",{enumerable:!1,configurable:!0,writable:!0,value:function(e){return Math.round(e*Math.pow(10,15))/Math.pow(10,15)}}),Object.defineProperty(t.prototype,"appendPagePenData",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t,n,i){var a,o,s=this;if(void 0===i&&(i="black"),!((null==t?void 0:t.length)<=0)){var l=this._pagesInfo[e];if(!l){if(!n)throw new Error("canvas参数为空");l=this._pagesInfo[e]=this._createPage(e,n)}var u=null!==(a=null==l?void 0:l.penDatas)&&void 0!==a?a:[],c=null!==(o=null==l?void 0:l.leftPenDatas)&&void 0!==o?o:[],f=u[u.length-1],p=t.map((function(e){return"PEN_MOVE"===e.type&&(f&&"PEN_UP"!==f.type||(e.type="PEN_DOWN")),f=e,r({strokeStyle:i},s._transformPagePointToCanvasPoint(n.width,n.height,e))}));u=u.concat(p),c=c.concat(p),l.penDatas=u,l.leftPenDatas=c,this._firstPointTimestamp?u[0].ts<this._firstPointTimestamp&&(this._firstPointTimestamp=u[0].ts):this._firstPointTimestamp=u[0].ts}}}),Object.defineProperty(t.prototype,"_createPage",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){return new o(e,t,this._config.strokeWidth)}}),Object.defineProperty(t.prototype,"destroy",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e=this;Object.keys(this._pagesInfo).forEach((function(t){e._pagesInfo[t].destroy()})),this._pagesInfo=null,this._config=null,this._firstPointTimestamp=null}}),Object.defineProperty(t.prototype,"firstPointTimestramp",{get:function(){return this._firstPointTimestamp},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"lastPointTimestamp",{get:function(){var e,t=this;return this._pagesInfo?(Object.keys(this._pagesInfo).forEach((function(n){var i=t._pagesInfo[n].penDatas;if(0!==i.length){var r=i[i.length-1];e?r.ts>e&&(e=r.ts):e=r.ts}})),e):0},enumerable:!1,configurable:!0}),t}(a)),u=l;return e.Events=t,e.PenCorrectPlayer=u,e}({});
